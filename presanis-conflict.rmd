---
title: "Anne's HIV example"
author: "Andrew Manderson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontfamily: tgpagella
fontsize: 10pt
papersize: a4
geometry: margin=2.25cm
bibliography: ../0bibliography/year-1-bib.bib
csl: aam71-test.csl
output: 
  pdf_document:
    includes:
      in_header:
        tex-input/pre.tex
    fig_caption: true
    number_sections: true
    keep_tex: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, out.width = "85%", fig.align = "center", auto_pdf = TRUE)
```

# HIV Conflict model

The HIV example of @ades:cliffe:02 and @presanis:etal:13 considers an evidence synthesis model for inferring the efficacy of HIV screening in prenatal clinics.
The evidence synthesis model has 8 _basic parameters_ $a, b, \ldots, h$ , which are group membership probabilities for certain risk groups and subgroups thereof.
The first risk group partitions the prenatal clinic attendees into those born in sub-Saharan Africa (SSA), injecting drug users (IDU), and the remaining women, which have corresponding probabilities $a, b$, and  $1 - a - b$.
Conditional on this response, the populations are then subdivided based on whether they are infected with HIV, which have probabilities $c, d$ and $e$ respectively, and if they have already been diagnosed prior to visiting the clinic, with probabilities $f, g$ and $h$.
@presanis:etal:13 define _direct evidence_ as a study that pertains directly to one of these basis parameters, with _indirect evidence_ as a study that relates to a basic parameter through a deterministic link function.
An additional probability is also included in the model, denoted $w$, which considers the prevalence of HIV serotype B.
This additional parameter enables the inclusion of an additional study which further inform the other basic parameters.
Table&nbsp;\ref{tab:HIV-data} summarises the basic parameters and their link functions, and Figure&nbsp;\ref{fig:hiv_model_tree} contains the decision tree that segments the prenatal clinic attendee populace into the various risk groups.

\input{tex-input/hiv-intro/0020-link-function-table.tex}

```{r hiv_model_tree, fig.cap = "Decision tree and corresponding basic parameters in the HIV example. Reproduced from Presanis et al. (2013)."}
knitr::include_graphics("plots/hiv-example/HIVtree.pdf")
```

## Model particulars

Our particular interest is in study 12, which informs the probability $p_{12}$, and provides indirect evidence for the basic parameters through the deterministic link function
\input{tex-input/hiv-intro/0010-study-link-function.tex}
We consider melding on the node corresponding to $p_{12}$, i.e. $\phi = \{p_{12}\}$.
The first submodel, consisting of the study data $y_{12}$ and the probability $p_{12}$, is the smaller submodel or submodel 1.
Mathematically,
\input{tex-input/hiv-submodels/0010-study-12-submodel.tex}
where we are free to choose $pd_{1}(\phi)$.
The other submodel considers the remaining studies and the induced prior on $p_{12}$, i.e. not including $y_{12}$ but still including $p_{12}$.
We refer to this as the large submodel, or submodel 2, and define it as
\input{tex-input/hiv-submodels/0020-big-submodel.tex}
which implicitly contains $p_{12}$.
@presanis:etal:13 investigates the effects of performing _node splits_ on the study probabilities as a means of diagnosing conflict between individual studies and the overall model.
The presence of conflict and unknown prior marginal distributions on the study indicates that our methodology for more accurately estimating self-density ratios is applicable.

## Prior data conflict for $p_{12}$

Initial experiments suggest that there is conflict between the induced prior on $p_{12}$, using the uninformative priors of @ades:cliffe:02, and the subposterior $\pd(p_{12} \mid y_{12})$.
This is driven by the flat prior on $w$, which causes an accumulation of probability mass of the a priori distribution for $p_{12}$ near $1$.
To exacerbate this conflict, we motivate the use of a slightly misspecified prior for $w \sim \text{Beta}(3, 1)$, by considering a reasonable prior for the time and place in which the study was constructed, and noting that the distribution of HIV serotypes differs considerably between North America and sub-Saharan Africa [@hemelaar:12].
This misspecified prior causes more probability mass to accumulate at the boundary, and the accuracy of the naive KDE estimate to decrease in the region of high posterior probability.

## Notation and submodels

Define the full data as the information from all 12 studies $Y = \{y_{1}, \ldots, y_{12}, n_{1}, \ldots, n_{12}\}$.
We are going to meld on $\phi = p_{12}$, and hence define $Y_{1} = \{y_{12}, n_{12}\}$ and $Y_{2} = \{y_{1}, \ldots, y_{11}, n_{1}, \ldots, n_{11}\}$.
There is a tacit prior on $\phi$ in the $m = 2$ model, and we get to choose an explicit prior in then $m = 1$ case.
We opt for a flat $\text{Beta}(1, 1)$ prior on $\phi$ to not distract from the conflict between the subposterior and the induced prior.
The pooled prior is formed using equally weighted logarithmic pooling, with weights equal to $1 \mathop{/} 2$.
This permits the use of the weighted self-density ratio estimate in both the stage one and stage two targets, through the prior marginal self-density ratio and the pooled prior respectively.

## Practicalities

Unless otherwise stated, 5000 samples are drawn from each density.
When MCMC is required, 5 chains are run to convergence, then 1000 samples are drawn from each chain.
The number of weighting functions $\Nw = 20$ for the `wsre` estimate, each using 500 MCMC samples.
This is comparable to the amount of information used for the naive KDE estimate, as the correlated nature of the MCMC samples means that each sample is less informative than the independent sample drawn from the prior.

# Full prior/posterior comparison

Figure&nbsp;\ref{fig:prior_post} compares all distributions considered in various stages of the melding process, for all parameters and derived quantities.


```{r prior_post, fig.cap = "A distributional comparison of the various distributions considered in the melding process. Conflict is immediately apparent for $p_{12}$, as there is considerable disagreement between the induced prior and the data-driven posterior."}
knitr::include_graphics("plots/hiv-example/prior-post-compare.pdf")
```

```{r sub_prior_post, fig.cap = "The subset of the parameters depicted in Figure \\ref{fig:prior_post}, which pertain to $p_{12}$."}
knitr::include_graphics("plots/hiv-example/p12-prior-post-compare.pdf")
```

```{r qq_plot_phi, fig.cap = "Quantile-Quantile plot of the melded posterior quantiles with the \\texttt{wsre} estimate (blue) and without (red). The comparison is made to the quantiles obtained by sampling the joint model directly."}
knitr::include_graphics("plots/hiv-example/posterior-qq-plot.pdf")
```


### `wsre` impact

The two purple colours of Figure&nbsp;\ref{fig:prior_post} pertain to stage one samples (of model two) from 
\input{tex-input/hiv-submodels/0030-stage-one-target.tex}
Specifically, $\hat{\pd_{2}'}(\phi)$ corresponds to the stage one target samples drawn using the self-density ratio estimate.
Our interest is predominately in $p_{12}$ and its constituent parameters, hence Figure&nbsp;\ref{fig:sub_prior_post} displays the distributions of the subset of parameters that are relevant to $p_{12}$.
The difference between the two is not considerable, but the slight shift to the right in the `wsre` estimates implies that we had an underestimate, in the ROI, of the prior marginal beforehand.
Additionally, more of the right tail is captured, and the estimate of the median is more accurate.
We can also compare the effect of the `wsre` methodology by considering the quantiles of $\hat{\pd}_{\text{meld}}(\phi \mid Y_{1}, Y_{2})$ obtained with and without `wsre`, and comparing them to the quantiles obtained directly from the joint posterior $\pd(\phi \mid Y)$.
Figure&nbsp;\ref{fig:qq_plot_phi} contains this comparison, and we see that the `wsre` estimate has moved the entire distribution towards the joint quantiles, which we are considering to be the baseline truth.


<!-- -------------------- END OF MAIN BODY OF DOCUMENT -------------------- -->
\newpage

<!-- The {-} tag here suppresses the section numbering. -->
# Bibliography {-}

<!-- This makes pandoc-citeproc put the references before the end of document. -->
<div id="refs"></div>

\newpage

<!-- Now switch to alphabetical numbering for the appendix, and reset the counter. -->
\renewcommand{\thesection}{\Alph{section}}
\setcounter{section}{0}

# Appendix 