---
title: "Anne's HIV example"
author: "Andrew Manderson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontfamily: tgpagella
fontsize: 10pt
papersize: a4
geometry: margin=2.25cm
bibliography: ../0bibliography/year-1-bib.bib
csl: aam71-test.csl
output: 
  pdf_document:
    includes:
      in_header:
        tex-input/pre.tex
    fig_caption: true
    number_sections: true
    keep_tex: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, out.width = "85%", fig.align = "center", auto_pdf = TRUE)
```

# HIV Conflict model

The HIV example of @ades:cliffe:02 and @presanis:etal:13 considers an evidence synthesis model for inferring the efficacy of HIV screening in prenatal clinics.
The evidence synthesis model has 8 _basic parameters_ $a, b, \ldots, h$ , which are group membership probabilities for certain risk groups and subgroups thereof.
The first risk group partitions the prenatal clinic attendees into those born in sub-Saharan Africa (SSA), injecting drug users (IDU), and the remaining women, which have corresponding probabilities $a, b$, and  $1 - a - b$.
Conditional on this response, the populations are then subdivided based on whether they are infected with HIV, which have probabilities $c, d$ and $e$ respectively, and if they have already been diagnosed prior to visiting the clinic, with probabilities $f, g$ and $h$.
@presanis:etal:13 define _direct evidence_ as a study that pertains directly to one of these basic parameters, and _indirect evidence_ as a study that relates to the basic parameters through a deterministic link function.
An additional probability is also included in the model, denoted $w$, which considers the prevalence of HIV serotype B.
This parameter enables the inclusion of an extra study which further informs the other basic parameters.
Table&nbsp;\ref{tab:HIV-data} summarises the basic parameters, their link functions, and the data used to inform the basic parameters.
The code to reproduce all the figures in this example is available at https://github.com/hhau/presanis-conflict-hiv-example.

<!-- and Figure&nbsp;\ref{fig:hiv_model_tree} contains the decision tree that segments the prenatal clinic attendee populace into the various risk groups.
 -->

\input{tex-input/hiv-intro/0020-link-function-table.tex}

## Model particulars

Our particular interest is in study 12, which informs the probability $p_{12}$, and provides indirect evidence for the basic parameters through the deterministic link function
\input{tex-input/hiv-intro/0010-study-link-function.tex}
Figure&nbsp;\ref{fig:model-dag} contains a DAG of the basic parameters that relate to $p_{12}$.
We consider melding on the node corresponding to $p_{12}$, i.e. $\phi = \{p_{12}\}$.
The first submodel, consisting of the study data $y_{12}$ and the probability $p_{12}$, is the smaller submodel or submodel $\modelindex = 1$.
Mathematically,
\input{tex-input/hiv-submodels/0010-study-12-submodel.tex}
where we are free to choose $\pd_{1}(\phi)$, and do so in Section&nbsp;\ref{notation-and-submodels}.
The other submodel considers the remaining studies and the induced prior on $p_{12}$, i.e. not including $y_{12}$ but still including $p_{12}$.
We refer to this as the large submodel, or submodel $\modelindex = 2$, and define it as
\input{tex-input/hiv-submodels/0020-big-submodel.tex}
which implicitly contains $p_{12}$.
@presanis:etal:13 investigates the effects of performing _node splits_ on the study probabilities as a means of diagnosing conflict between individual studies and the overall model.
This node splitting process can be reframed as an application of Markov melding.
The presence of conflict and unknown prior marginal distributions on the nodes of interest indicates that our methodology for more accurately estimating self-density ratios is applicable.
This example is also useful in its simplicity, as the joint model implied by Markov melding can be fit directly, which serves as a reference for the melded posterior computed via the multi-stage sampler. 

\input{tex-input/hiv-submodels/0040-model-dag.tex}

## Prior data conflict for $p_{12}$

Initial experiments suggest that there is conflict between the induced prior on $p_{12}$, using the uninformative priors of @ades:cliffe:02, and the subposterior $\pd(p_{12} \mid y_{12})$.
This is driven by the flat prior on $w$, which causes an accumulation of probability mass near 1 in the prior on $p_{12}$.
To exacerbate this conflict, we employ a slightly misspecified prior for $w \sim \text{Beta}(3, 1)$.
We motivate this by considering a reasonable prior for the time and place in which the evidence synthesis was constructed, and noting that the distribution of HIV serotypes differs considerably between North America and sub-Saharan Africa [@hemelaar:12].
This misspecified prior causes more probability mass to accumulate at the boundary, and the accuracy of the naive KDE estimate $\hat{\pd}_{2}(p_{12})$ to decrease in the region of high posterior probability.
The accumulation is visible in the second row of Figure&nbsp;\ref{fig:p12_all_melding_dists}, and the prior-subposterior conflict is visible in the 3rd and 4th row of Figure&nbsp;\ref{fig:p12_all_melding_dists}.


## Notation and submodels

Define the full data as the information from all 12 studies $Y = \{y_{1}, \ldots, y_{12}, n_{1}, \ldots, n_{12}\}$.
We are going to meld on $\phi = p_{12}$, and hence define $Y_{1} = \{y_{12}, n_{12}\}$ and $Y_{2} = \{y_{1}, \ldots, y_{11}, n_{1}, \ldots, n_{11}\}$.
There is a tacit prior on $\phi$ in the $m = 2$ model, and we get to choose an explicit prior in then $m = 1$ case.
We opt for a flat $\text{Beta}(1, 1)$ prior on $\phi$ to not distract from the conflict between the subposterior and the induced prior.
The pooled prior is formed using equally weighted logarithmic pooling, with weights equal to $1 \mathop{/} 2$.
This permits the use of the weighted-sample self-density ratio estimate in both the stage one and stage two targets, through the prior marginal self-density ratio and the pooled prior respectively.

## Example details
<!-- 
Unless otherwise stated, 5000 samples are drawn from each density.
When MCMC is required, 5 chains are run to convergence, then 1000 samples are drawn from each chain.
 -->

To demonstrate the effectiveness of our self-density ratio estimation methodology, we compare the melded posterior obtained using our method against the melded posterior obtained using the naive KDE estimate for the prior marginal.
For a fair comparison, we estimate the prior marginal distribution of interest, $\hat{\pd}_{2}(\phi)$, using 2500 Monte Carlo samples, and compare this against the self-density ratio estimate produced using 2500 samples in total.
The number of weighting functions was specified to be $\Nw = 10$ for the self-density ratio estimate of 
\input{tex-input/hiv-submodels/0050-self-ratio-estimate.tex}
Each weighting function has a specific mean $\mu_{\wfindex}$, and all have a common variance $\sigma_{\wfindex}^{2} = 0.25^2$.
The weighting function means consisted of $\Nw$ evenly spaced values between 0.01 and 0.99, and each weighted target had 250 post warmup MCMC samples drawn from it.
This set-up is slightly advantageous for the naive KDE method, as it uses Monte Carlo samples, as opposed to the self-density ratio estimate's MCMC samples.
Hence, the naive KDE makes use of a sample comprised of 2500 effective samples, whilst the self-density ratio estimate uses a sample with fewer than 2500 effective samples.

## Assessing the self-density ratio estimate impact

Figure&nbsp;\ref{fig:p12_all_melding_dists} compares all distributions considered in various stages of the melding process for $\phi = p_{12}$.
The two purple colours of Figure&nbsp;\ref{fig:p12_all_melding_dists} pertain to stage one samples (of model two) from 
\input{tex-input/hiv-submodels/0030-stage-one-target.tex}
Specifically, $\pd_{2}(\phi, \psi_{2}, Y_{2}) \mathop{/} \hat{\pd_{2}'}(\phi)$ corresponds to the stage one target samples drawn using the weighted self-density ratio estimate.
The difference between the two is not considerable, but the shift to the right in the weighted self-density ratio estimate  implies that the naive KDE had underestimated, in the region of interest, the prior marginal distribution.
Additionally, more of the right tail is captured, and the estimate of the median is more accurate.
These differences are also present in the estimated melded posterior distributions $\hat{\pd}_{\text{meld}}(\phi \mid Y_{1}, Y_{2})$ displayed in orange in Figure&nbsp;\ref{fig:p12_all_melding_dists}.
We can also compare the effect of our methodology by considering the quantiles of the melded posterior distributions obtained with, $\hat{\pd'}_{\text{meld}}(\phi \mid Y_{1}, Y_{2})$, and without, $\hat{\pd}_{\text{meld}}(\phi \mid Y_{1}, Y_{2})$, the weighted self-density ratio estimate, and comparing them to the quantiles obtained directly from the joint posterior $\pd(\phi \mid Y)$.
Figure&nbsp;\ref{fig:qq_plot_phi} contains this comparison, and we see that the self-density estimate has moved the entire distribution towards the joint quantiles, which we consider to be the baseline truth.


```{r p12_all_melding_dists, fig.cap = "Boxplots of all distributions considered in the Markov melding process. From top to bottom: submodel prior distributions (blue), subposterior distributions (green), stage one target distributions with \\& without our self-density ratio estimation methodology (purple), corresponding melded posterior distributions (orange), and reference melded posterior distribution (red)."}
knitr::include_graphics("plots/hiv-example/p12-only-melding-dists.pdf")
```

```{r qq_plot_phi, fig.cap = "Quantile-Quantile plot of the melded posterior quantiles with the weighted self-density ratio estimate  (WSRE, dots) and without (Naive, crosses). The comparison is made to the quantiles obtained from the reference samples (which uses a parameteric Beta density approximation from 100,00 data points)."}
knitr::include_graphics("plots/hiv-example/posterior-qq-plot.pdf")
```

\newpage

## Visualising the ratio estimates

- may be some quantity was stale / had not been updated, but the QQ plot looks a lot better now? (see Figure \ref{fig:qq_plot_phi})?
    - Given that the makefile dependencies look correct, this tends to suggest the estimate is unstable? We should run the whole process for both things a lot of times, and get some uncertainty intervals for the QQ plot?
- distance seems to be driving the uncertainty / poor performance visible in figure \ref{fig:ratio_estimates_full}, which we can infer from the proportions plot in Figure&nbsp;\ref{fig:which_est}.
    - Suggests that telescoping may be a good idea
        - particularly if we can get it down to one ratio estimate per telescoping ratio
        - can take the telescoping term centers to be the empirical means of weighted target samples
- the influence of the unweighted estimate is visible in the proportion plots 
    - the unweighted estimate is in black, and because it has not been multiplied by a weighting function, it has higher variance and hence a larger bandwidth. 
    - Larger bandwidth means slower tail decay, hence it alone influences the estimate when the numerator and denominator are far apart.

```{r ratio_estimates_full, fig.cap = "overall ratio estimate"}
knitr::include_graphics("plots/hiv-example/ratio-estimates-full.pdf")
```

<!-- ```{r ratio_estimates_zoomed}
knitr::include_graphics("plots/hiv-example/ratio-estimates-zoomed.pdf")
```

## which ratio estimate is contributing at what point
 -->

\begin{landscape}
```{r which_est, fig.cap = "proportions plot of the weighting functions."}
knitr::include_graphics("plots/hiv-example/contributing-wf.pdf")
```
\end{landscape}

<!-- -------------------- END OF MAIN BODY OF DOCUMENT -------------------- -->
\newpage

<!-- The {-} tag here suppresses the section numbering. -->
# Bibliography {-}

<!-- This makes pandoc-citeproc put the references before the end of document. -->
<div id="refs"></div>

\newpage

<!-- Now switch to alphabetical numbering for the appendix, and reset the counter. -->
\renewcommand{\thesection}{\Alph{section}}
\setcounter{section}{0}

# Appendix 